{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 text-cyan">
                <i class="fas fa-clipboard-list me-2"></i>Supervisor Dashboard
            </h1>
            <p class="text-muted">Shift Performance & Efficiency Monitoring | {{ today }} - {{ current_shift|title }} Shift</p>
        </div>
        <div class="col-auto">
            <div class="dashboard-card">
                <div class="btn-group">
                    <button class="btn btn-cyan btn-sm" onclick="downloadShiftReportPDF()">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </button>
                    <button class="btn btn-success btn-sm" onclick="downloadShiftReportCSV()">
                        <i class="fas fa-file-csv me-1"></i>CSV
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="downloadShiftReportExcel()">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">Total Trucks</div>
                <div class="kpi-value">{{ metrics.total_trucks }}</div>
                <small class="text-success">+5% vs last shift</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">Avg Turnaround</div>
                <div class="kpi-value">{{ metrics.avg_turnaround_time }}m</div>
                <small class="text-success">-2m vs target</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">On Time %</div>
                <div class="kpi-value">{{ metrics.on_time_percentage }}%</div>
                <small class="text-success">+3% vs target</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">Dock Utilization</div>
                <div class="kpi-value">{{ metrics.dock_utilization }}%</div>
                <small class="text-warning">-5% vs target</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">Safety Events</div>
                <div class="kpi-value">{{ metrics.safety_violations }}</div>
                <small class="text-danger">+2 vs last shift</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="text-muted">Delay %</div>
                <div class="kpi-value">{{ metrics.delay_percentage }}%</div>
                <small class="text-success">-1% vs target</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Charts & Data -->
        <div class="col-lg-8">
            <!-- Performance Overview -->
            <div class="dashboard-card">
                <h5><i class="fas fa-chart-line me-2"></i>Performance Overview</h5>
                <div class="row text-center mt-4">
                    <div class="col-md-3 mb-3">
                        <div class="kpi-value text-info">{{ gate_in_count }}</div>
                        <small class="text-muted">Gate In</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="kpi-value text-warning">{{ docked_count }}</div>
                        <small class="text-muted">Docked</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="kpi-value text-primary">{{ loading_count }}</div>
                        <small class="text-muted">Loading</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="kpi-value text-success">{{ departed_count }}</div>
                        <small class="text-muted">Departed</small>
                    </div>
                </div>
            </div>

            <!-- Dock Utilization Heatmap -->
            <div class="dashboard-card">
                <h5><i class="fas fa-fire me-2"></i>Dock Utilization Heatmap</h5>
                <div class="row text-center mt-4">
                    {% for dock in docks %}
                    <div class="col-md-2 mb-3">
                        <div class="p-3 rounded {% if dock.utilization_rate > 80 %}bg-danger{% elif dock.utilization_rate > 60 %}bg-warning{% elif dock.utilization_rate > 40 %}bg-info{% else %}bg-success{% endif %}">
                            <strong>Dock {{ dock.dock_id }}</strong>
                        </div>
                        <small class="text-muted mt-1">{{ dock.utilization_rate }}%</small>
                        <div class="small {% if dock.is_occupied %}text-warning{% else %}text-success{% endif %}">
                            {% if dock.is_occupied %}Occupied{% else %}Available{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Shift Events Table -->
            <div class="dashboard-card">
                <h5><i class="fas fa-list me-2"></i>Recent Shift Events</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Truck ID</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in shift_events|slice:":10" %}
                            <tr>
                                <td>{{ event.timestamp|time }}</td>
                                <td class="text-cyan">{{ event.truck.truck_id }}</td>
                                <td>
                                    <span class="badge 
                                        {% if event.event_type == 'gate_in' %}bg-info
                                        {% elif event.event_type == 'docked' %}bg-warning
                                        {% elif event.event_type == 'departed' %}bg-success
                                        {% else %}bg-primary{% endif %}">
                                        {{ event.get_event_type_display }}
                                    </span>
                                </td>
                                <td>{{ event.location }}</td>
                                <td>
                                    <span class="status-indicator 
                                        {% if event.event_type == 'departed' %}status-active
                                        {% else %}status-warning{% endif %}"></span>
                                    {{ event.truck.get_current_status_display }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <p>No events recorded for this shift</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Analytics & Controls -->
        <div class="col-lg-4">
            <!-- Shift Summary -->
            <div class="dashboard-card">
                <h5><i class="fas fa-clipboard-check me-2"></i>Shift Summary</h5>
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">Shift</small>
                        <div class="fw-bold text-cyan">{{ current_shift|title }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Date</small>
                        <div class="fw-bold">{{ today }}</div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">Shift Start</small>
                        <div class="fw-bold">06:00</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Current Time</small>
                        <div class="fw-bold" id="shift-time">--:--</div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Active Trucks</small>
                        <div class="fw-bold text-cyan">{{ shift_events.count }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Completed</small>
                        <div class="fw-bold text-success">{{ departed_count }}</div>
                    </div>
                </div>
            </div>

            <!-- Equipment Activity -->
            <div class="dashboard-card">
                <h5><i class="fas fa-tools me-2"></i>Equipment Activity</h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">Forklifts Active</span>
                        <span class="fw-bold">8/12</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: 67%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">Cranes Active</span>
                        <span class="fw-bold">3/5</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" style="width: 60%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">Loaders Active</span>
                        <span class="fw-bold">2/4</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-info" style="width: 50%"></div>
                    </div>
                </div>
                <button class="btn btn-outline-cyan btn-sm w-100 mt-2">
                    <i class="fas fa-sync me-1"></i>Update Equipment Status
                </button>
            </div>

            <!-- Safety & Compliance -->
            <div class="dashboard-card">
                <h5><i class="fas fa-exclamation-triangle me-2 text-amber"></i>Safety & Compliance</h5>
                <div class="alert alert-warning mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Safety Score</strong>
                        <span class="fw-bold">88%</span>
                    </div>
                    <small class="text-muted">{{ metrics.safety_violations }} violations this shift</small>
                </div>
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>PPE Violations</span>
                        <span class="text-danger">1</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Zone Breaches</span>
                        <span class="text-warning">1</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Overspeed Events</span>
                        <span class="text-success">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Equipment Issues</span>
                        <span class="text-info">0</span>
                    </div>
                </div>
                <button class="btn btn-outline-warning btn-sm w-100 mt-3">
                    <i class="fas fa-file-alt me-1"></i>Generate Safety Report
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <h5><i class="fas fa-bolt me-2 text-cyan"></i>Quick Actions</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-cyan btn-sm">
                        <i class="fas fa-broadcast-tower me-1"></i>Shift Broadcast
                    </button>
                    <button class="btn btn-outline-info btn-sm">
                        <i class="fas fa-users me-1"></i>Team Management
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadShiftReportPDF()">
                        <i class="fas fa-file-export me-1"></i>Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Update shift time
function updateShiftTime() {
    const now = new Date();
    document.getElementById('shift-time').textContent = 
        now.getHours().toString().padStart(2, '0') + ':' + 
        now.getMinutes().toString().padStart(2, '0');
}

function downloadShiftReportPDF() {
    window.open('/download/shift-report/pdf/', '_blank');
}

function downloadShiftReportCSV() {
    window.open('/download/shift-report/csv/', '_blank');
}

function downloadShiftReportExcel() {
    window.open('/download/shift-report/excel/', '_blank');
}

// Update every minute
setInterval(updateShiftTime, 60000);
updateShiftTime();
</script>
{% endblock %}